#!/usr/bin/env python3
#
# Copyright 2022 ScyllaDB
#
# SPDX-License-Identifier: Apache-2.0

import argparse
import json
import os
import re
import sys
from pathlib import Path

from lib.scylla_cloud import AwsInstance, colorprint, is_ec2, out


CACHE_FILE = "/var/lib/scylla-housekeeping/ec2_check_cache.json"


def get_instance_identity():
    """Get instance identity metadata to detect if instance has changed."""
    aws = AwsInstance()
    return {
        "instance_id": aws._AwsInstance__instance_metadata("meta-data/instance-id"),
        "instance_type": aws.instancetype,
    }


def load_cache():
    """Load cached check results."""
    try:
        if os.path.exists(CACHE_FILE):
            with open(CACHE_FILE, "r") as f:
                return json.load(f)
    except (json.JSONDecodeError, IOError):
        pass
    return None


def save_cache(data):
    """Save check results to cache."""
    try:
        cache_dir = os.path.dirname(CACHE_FILE)
        os.makedirs(cache_dir, mode=0o755, exist_ok=True)
        with open(CACHE_FILE, "w") as f:
            json.dump(data, f, indent=2)
    except IOError as e:
        print(f"Warning: Failed to save cache: {e}", file=sys.stderr)


def is_cache_valid(cache_data, current_identity):
    """Check if cached results are still valid."""
    if not cache_data:
        return False
    
    # Check if instance identity matches
    cached_identity = cache_data.get("instance_identity", {})
    if cached_identity.get("instance_id") != current_identity.get("instance_id"):
        return False
    if cached_identity.get("instance_type") != current_identity.get("instance_type"):
        return False
    
    # Check if the check was successful
    return cache_data.get("check_passed", False)


def run_ec2_checks(nic):
    """Run the actual EC2 optimization checks."""
    if not os.path.exists(f"/sys/class/net/{nic}"):
        print(f"NIC {nic} doesn't exist.")
        sys.exit(1)

    aws = AwsInstance()
    instance_class = aws.instance_class()
    en = aws.get_en_interface_type()
    match = re.search(r"^driver: (\S+)$", out(f"ethtool -i {nic}"), flags=re.MULTILINE)
    driver = match.group(1)

    if not en:
        colorprint("{red}{instance_class} doesn't support enhanced networking!{nocolor}", instance_class=instance_class)
        print("""To enable enhanced networking, please use the instance type which supports it.
More documentation available at:
http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/enhanced-networking.html#enabling_enhanced_networking""")
        return False
    elif not aws.is_vpc_enabled(nic):
        colorprint("{red}VPC is not enabled!{nocolor}")
        print("To enable enhanced networking, please enable VPC.")
        return False
    elif driver != en:
        colorprint("{red}Enhanced networking is disabled!{nocolor}")
        print("""More documentation available at:
http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/enhanced-networking.html""")
        return False

    return True


if __name__ == "__main__":
    if not is_ec2():
        sys.exit(0)
    
    parser = argparse.ArgumentParser(description="Verify EC2 configuration is optimized.")
    parser.add_argument("--nic", default="eth0", help="specify NIC")
    parser.add_argument("--force-check", action="store_true", 
                        help="force check even if cached results exist")
    args = parser.parse_args()

    # Try to use cache if not forced
    if not args.force_check:
        current_identity = get_instance_identity()
        cache_data = load_cache()
        
        if is_cache_valid(cache_data, current_identity):
            colorprint("{green}This EC2 instance is optimized for Scylla (cached result).{nocolor}")
            sys.exit(0)

    # Run actual checks
    check_passed = run_ec2_checks(args.nic)
    
    if check_passed:
        # Save successful check to cache
        current_identity = get_instance_identity()
        cache_data = {
            "instance_identity": current_identity,
            "check_passed": True,
        }
        save_cache(cache_data)
        colorprint("{green}This EC2 instance is optimized for Scylla.{nocolor}")
        sys.exit(0)
    else:
        sys.exit(1)
