#!/usr/bin/env python3
#
# Copyright 2022 ScyllaDB
#
# SPDX-License-Identifier: Apache-2.0

import logging
import os
import subprocess
import sys
from abc import ABCMeta, abstractmethod

import yaml

from lib.scylla_cloud import get_cloud_instance, is_azure, is_ec2, is_gce, is_oci


class UnsupportedInstanceClassError(Exception):
    pass


class CloudIoSetup(metaclass=ABCMeta):
    @abstractmethod
    def generate(self):
        pass

    def save(self):
        assert "read_iops" in self.disk_properties
        with open("/etc/scylla.d/io_properties.yaml", "w") as properties_file:
            yaml.dump({"disks": [self.disk_properties]}, properties_file, default_flow_style=False)
        with open("/etc/scylla.d/io.conf", "w") as ioconf:
            ioconf.write('SEASTAR_IO="--io-properties-file=/etc/scylla.d/io_properties.yaml"\n')
        os.chmod("/etc/scylla.d/io_properties.yaml", 0o644)
        os.chmod("/etc/scylla.d/io.conf", 0o644)


class AwsIoSetup(CloudIoSetup):
    def __init__(self, idata):
        self.idata = idata
        self.disk_properties = {}

    def generate(self):
        if not self.idata.is_supported_instance_class():
            logging.error("This is not a recommended EC2 instance setup for auto local disk tuning.")
            raise UnsupportedInstanceClassError()
        self.disk_properties["mountpoint"] = "/var/lib/scylla"
        nr_disks = len(self.idata.get_local_disks())
        instance_type = self.idata.instancetype
        instance_class_all = self.idata.instance_class() + ".ALL"
        with open("/opt/scylladb/scylla-machine-image/aws_io_params.yaml") as f:
            io_params = yaml.safe_load(f)

        t = None
        if instance_type in io_params:
            t = instance_type
        elif instance_class_all in io_params:
            t = instance_class_all
        if t:
            for p in ["read_iops", "read_bandwidth", "write_iops", "write_bandwidth"]:
                self.disk_properties[p] = io_params[t][p] * nr_disks
            self.save()
        else:
            logging.warning("This is a supported instance but with no pre-configured io, scylla_io_setup will be run")
            try:
                subprocess.run("scylla_io_setup", shell=True, check=True, capture_output=True, timeout=300)
            except subprocess.CalledProcessError as e:
                logging.error(f"scylla_io_setup failed with error: {e.stderr.decode().strip()}")
                raise


class GcpIoSetup(CloudIoSetup):
    def __init__(self, idata):
        self.idata = idata
        self.disk_properties = {}

    def generate(self):
        if not self.idata.is_supported_instance_class():
            logging.error("This is not a recommended Google Cloud instance setup for auto local disk tuning.")
            raise UnsupportedInstanceClassError()
        self.disk_properties["mountpoint"] = "/var/lib/scylla"

        instance_type = self.idata.instancetype
        nr_disks = self.idata.nvme_disk_count

        # Try to load instance-specific parameters from YAML file
        try:
            with open("/opt/scylladb/scylla-machine-image/gcp_io_params.yaml") as f:
                io_params = yaml.safe_load(f)

            t = None
            if instance_type in io_params:
                t = instance_type

            if t:
                for p in ["read_iops", "read_bandwidth", "write_iops", "write_bandwidth"]:
                    self.disk_properties[p] = io_params[t][p]
                self.save()
                return
        except FileNotFoundError:
            logging.warning("GCP I/O parameters file not found, falling back to disk-count-based logic")
        except Exception as e:
            logging.warning(f"Error loading GCP I/O parameters: {e}, falling back to disk-count-based logic")

        # Fallback to original disk-count-based logic for instances not in YAML
        # below is based on https://cloud.google.com/compute/docs/disks/local-ssd#performance
        # and https://cloud.google.com/compute/docs/disks/local-ssd#nvme
        # note that scylla iotune might measure more, this is GCP recommended
        mbs = 1024 * 1024
        if nr_disks >= 1 and nr_disks < 4:
            self.disk_properties["read_iops"] = 170000 * nr_disks
            self.disk_properties["read_bandwidth"] = 660 * mbs * nr_disks
            self.disk_properties["write_iops"] = 90000 * nr_disks
            self.disk_properties["write_bandwidth"] = 350 * mbs * nr_disks
        elif nr_disks >= 4 and nr_disks <= 8:
            self.disk_properties["read_iops"] = 680000
            self.disk_properties["read_bandwidth"] = 2650 * mbs
            self.disk_properties["write_iops"] = 360000
            self.disk_properties["write_bandwidth"] = 1400 * mbs
        elif nr_disks == 16:
            self.disk_properties["read_iops"] = 1600000
            self.disk_properties["read_bandwidth"] = 4521251328
            # below is google, above is our measured
            # self.disk_properties["read_bandwidth"] = 6240 * mbs
            self.disk_properties["write_iops"] = 800000
            self.disk_properties["write_bandwidth"] = 2759452672
            # below is google, above is our measured
            # self.disk_properties["write_bandwidth"] = 3120 * mbs
        elif nr_disks == 24:
            self.disk_properties["read_iops"] = 2400000
            self.disk_properties["read_bandwidth"] = 5921532416
            # below is google, above is our measured
            # self.disk_properties["read_bandwidth"] = 9360 * mbs
            self.disk_properties["write_iops"] = 1200000
            self.disk_properties["write_bandwidth"] = 4663037952
            # below is google, above is our measured
            # self.disk_properties["write_bandwidth"] = 4680 * mbs

        if "read_iops" in self.disk_properties:
            self.save()
        else:
            logging.warning("This is a supported instance but with no pre-configured io, scylla_io_setup will be run")
            subprocess.run("scylla_io_setup", shell=True, check=True, capture_output=True, timeout=300)


class AzureIoSetup(CloudIoSetup):
    def __init__(self, idata):
        self.idata = idata
        self.disk_properties = {}

    def generate(self):
        if not self.idata.is_supported_instance_class():
            logging.error("This is not a recommended Azure Cloud instance setup for auto local disk tuning.")
            raise UnsupportedInstanceClassError()

        self.disk_properties["mountpoint"] = "/var/lib/scylla"
        instance_type = self.idata.instancetype

        # Try to load instance-specific parameters from YAML file
        try:
            with open("/opt/scylladb/scylla-machine-image/azure_io_params.yaml") as f:
                io_params = yaml.safe_load(f)

            if instance_type in io_params:
                disk_params = io_params[instance_type]["disks"][0]
                for p in ["read_iops", "read_bandwidth", "write_iops", "write_bandwidth"]:
                    self.disk_properties[p] = disk_params[p]
                self.save()
                return
        except FileNotFoundError:
            logging.warning("Azure I/O parameters file not found, falling back to scylla_io_setup")
        except Exception as e:
            logging.warning(f"Error loading Azure I/O parameters: {e}, falling back to scylla_io_setup")

        # Fallback to scylla_io_setup for instances not in YAML
        logging.warning("This is a supported instance but with no pre-configured io, scylla_io_setup will be run")
        subprocess.run("scylla_io_setup", shell=True, check=True, capture_output=True, timeout=300)


class OciIoSetup(CloudIoSetup):
    def __init__(self, idata):
        self.idata = idata
        self.disk_properties = {}

    def generate(self):
        if not self.idata.is_supported_instance_class():
            logging.error("This is not a recommended OCI instance setup for auto local disk tuning.")
            raise UnsupportedInstanceClassError()

        self.disk_properties["mountpoint"] = "/var/lib/scylla"
        instance_type = self.idata.instancetype
        ocpus = self.idata.ocpus

        # Try to load instance-specific parameters from YAML file
        try:
            with open("/opt/scylladb/scylla-machine-image/oci_io_params.yaml") as f:
                io_params = yaml.safe_load(f)

            lookup_key = None
            if "Flex" in instance_type and ocpus:
                flex_key = f"{instance_type}-{ocpus}"
                if flex_key in io_params:
                    lookup_key = flex_key

            if not lookup_key and instance_type in io_params:
                lookup_key = instance_type

            if lookup_key:
                for p in ["read_iops", "read_bandwidth", "write_iops", "write_bandwidth"]:
                    self.disk_properties[p] = io_params[lookup_key][p]
                self.save()
                return

        except FileNotFoundError:
            logging.warning("OCI I/O parameters file not found, falling back to scylla_io_setup logic")
        except Exception as e:
            logging.warning(f"Error loading OCI I/O parameters: {e}, falling back to scylla_io_setup logic")

        if "read_iops" in self.disk_properties:
            self.save()
        else:
            logging.warning("This is a supported instance but with no pre-configured io, scylla_io_setup will be run")
            try:
                subprocess.run("scylla_io_setup", shell=True, check=True, capture_output=True, timeout=300)
            except subprocess.TimeoutExpired as e:
                stderr = e.stderr.decode().strip() if e.stderr else ""
                logging.error(f"scylla_io_setup timed out after {e.timeout} seconds. Stderr: {stderr}")
                raise
            except subprocess.CalledProcessError as e:
                logging.error(f"scylla_io_setup failed with error: {e.stderr.decode().strip()}")
                raise


if __name__ == "__main__":
    if not os.path.ismount("/var/lib/scylla"):
        logging.error("RAID volume not mounted")
        sys.exit(1)
    cloud_instance = get_cloud_instance()
    if is_ec2():
        io = AwsIoSetup(cloud_instance)
    elif is_gce():
        io = GcpIoSetup(cloud_instance)
    elif is_azure():
        io = AzureIoSetup(cloud_instance)
    elif is_oci():
        io = OciIoSetup(cloud_instance)
    try:
        io.generate()
    except UnsupportedInstanceClassError:
        sys.exit(1)
