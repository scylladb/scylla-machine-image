name: Trigger Jenkins Job

on:
  push:
    branches:
      - next**

jobs:
  trigger-jenkins:
    runs-on: ubuntu-latest
    steps:
      - name: Determine Jenkins Job Name
        run: |
          if [[ "${{ github.ref_name }}" == "next" ]]; then
            echo "JOB_NAME=scylla-master/job/next-machine-image" >> $GITHUB_ENV
          else
            VERSION=$(echo "${{ github.ref_name }}" | awk -F'-' '{print $2}')
            echo "JOB_NAME=scylla-${VERSION}/job/next-machine-image" >> $GITHUB_ENV
          fi

      - name: Trigger Jenkins Job
        env:
          JENKINS_USER: ${{ secrets.JENKINS_USERNAME }}
          JENKINS_API_TOKEN: ${{ secrets.JENKINS_TOKEN }}
          JENKINS_URL: "https://jenkins.scylladb.com"
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          echo "Triggering Jenkins Job: $JOB_NAME"
          if ! curl -X POST "$JENKINS_URL/job/$JOB_NAME/buildWithParameters" --fail --user "$JENKINS_USER:$JENKINS_API_TOKEN" -i -v; then
            echo "Error: Jenkins job trigger failed"

            # Send Slack message
            curl -X POST -H 'Content-type: application/json' \
              -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
              --data '{
                "channel": "#jenkins-notifications",
                "text": "ðŸš¨ Jenkins job *'$JOB_NAME'* failed!",
                "icon_emoji": ":warning:"
              }' \
              https://slack.com/api/chat.postMessage

            exit 1
          fi
