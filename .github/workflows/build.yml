on:
  push:
    branches:
      - master
      - next
  
  pull_request:
    branches:
      - next

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    name: Unittest and Build RPMs
    steps:
      - uses: actions/checkout@v6
      
      # 1. Setup a bootstrap Python to run our detection script
      - name: Setup Bootstrap Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: Install dependencies for version detection
        run: pip install requests

      # 2. Run the detection script
      # This fetches the Dockerfile, finds the Fedora version, 
      # checks Fedora sources for the Python version, and sets the output.
      - name: Detect Python Version from Dockerfile
        id: detect_python
        shell: python
        env:
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          import re
          import requests
          import os
          import sys

          # Get the current branch name from GitHub context
          # For PRs, use base_ref (target branch), otherwise use ref_name
          branch_name = os.environ.get('GITHUB_BASE_REF') or os.environ.get('GITHUB_REF_NAME', 'master')
          print(f"[*] Current branch: {branch_name}")

          def get_fedora_version_from_dockerfile():
              # Try to fetch Dockerfile from the same branch name
              dockerfile_url = f"https://raw.githubusercontent.com/scylladb/scylladb/{branch_name}/tools/toolchain/Dockerfile"
              print(f"[*] Fetching Dockerfile: {dockerfile_url}")
              
              try:
                  resp = requests.get(dockerfile_url)
                  
                  # If branch not found, fall back to master
                  if resp.status_code == 404:
                      print(f"[!] Branch '{branch_name}' not found, falling back to master")
                      dockerfile_url = "https://raw.githubusercontent.com/scylladb/scylladb/master/tools/toolchain/Dockerfile"
                      print(f"[*] Fetching Dockerfile: {dockerfile_url}")
                      resp = requests.get(dockerfile_url)
                  
                  resp.raise_for_status()
                  content = resp.text
                  
                  # Strategy 1: Look for ARG FEDORA_VERSION=40
                  arg_match = re.search(r'ARG\s+FEDORA_VERSION=(\d+)', content)
                  if arg_match:
                      return arg_match.group(1)
                  
                  # Strategy 2: Look for FROM fedora:40
                  from_match = re.search(r'FROM\s+.*fedora:(\d+)', content)
                  if from_match:
                      return from_match.group(1)
                      
                  print("::error::Could not find FEDORA_VERSION or FROM fedora:XX in Dockerfile")
                  sys.exit(1)
              except Exception as e:
                  print(f"::error::Failed to fetch Dockerfile: {e}")
                  sys.exit(1)

          def get_python_version_from_fedora(fedora_ver):
              import subprocess
              
              print(f"[*] Querying Fedora {fedora_ver} container for Python version...")
              
              try:
                  # Query the Fedora container for the Python version
                  # This is more reliable than parsing spec files and works for any Fedora version
                  cmd = [
                      'docker', 'run', '--rm', f'fedora:{fedora_ver}',
                      'bash', '-c',
                      'dnf repoquery --quiet --queryformat "%{VERSION}" python3 2>/dev/null | head -1'
                  ]
                  
                  result = subprocess.run(cmd, capture_output=True, text=True, timeout=60)
                  
                  if result.returncode == 0 and result.stdout.strip():
                      full_ver = result.stdout.strip()
                      # Take only Major.Minor for actions/setup-python (e.g., 3.14.2 -> 3.14)
                      short_ver = ".".join(full_ver.split('.')[:2])
                      print(f"[*] Found Python {short_ver} from Fedora {fedora_ver} repository")
                      return short_ver
                  else:
                      print(f"[!] Failed to query Fedora container: {result.stderr[:200]}")
              except subprocess.TimeoutExpired:
                  print(f"[!] Timeout querying Fedora container")
              except Exception as e:
                  print(f"[!] Error querying Fedora container: {e}")
              
              # Fallback: default to Python 3.13 for modern Fedora versions
              print(f"[!] Using default Python 3.13 for Fedora {fedora_ver}")
              return "3.13"

          # --- Main Execution ---
          fedora_ver = get_fedora_version_from_dockerfile()
          print(f"[*] Detected Fedora Version: {fedora_ver}")
          
          py_ver = get_python_version_from_fedora(fedora_ver)
          print(f"[*] Mapped to Python Version: {py_ver}")

          # Write to GITHUB_OUTPUT
          with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
              fh.write(f"matrix_python={py_ver}\n")

      # 3. Use the detected version for the actual work
      - name: Setup Target Python Environment
        uses: actions/setup-python@v6
        with:
          # This pulls the value from the previous step
          python-version: ${{ steps.detect_python.outputs.matrix_python }}
          architecture: x64

      - name: Verify Python Version
        run: |
          python --version
          echo "Environment successfully set to match ScyllaDB Toolchain!"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ steps.detect_python.outputs.matrix_python }}

      - name: sync dependencies
        run: |
            uv sync --all-extras
            
      - name: Run pre-commit
        run: |
            uv run pre-commit run --all-files

      - name: unittest
        run: |
            uv run pytest ./tests

      - name: Build RPM (Rockylinux:8)
        run: docker run -v `pwd`:/scylla-machine-image -w /scylla-machine-image  --rm rockylinux:8 bash -c 'dnf update -y; dnf install -y git ; git config --global --add safe.directory "*"; ./dist/redhat/build_rpm.sh -t centos8'

      - name: Build DEB (Ubuntu:22.04)
        run: docker run -v `pwd`:/scylla-machine-image -w /scylla-machine-image  --rm ubuntu:22.04 bash -c 'apt update -y; apt install -y git ; git config --global --add safe.directory "*"; ./dist/debian/build_deb.sh'
