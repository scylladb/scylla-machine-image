on:
  push:
    branches:
      - master
      - next
  
  pull_request:
    branches:
      - next

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    name: Unittest and Build RPMs
    steps:
      - uses: actions/checkout@v6
      
      # 1. Setup a bootstrap Python to run our detection script
      - name: Setup Bootstrap Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: Install dependencies for version detection
        run: pip install requests

      # 2. Run the detection script
      # This fetches the Dockerfile, finds the Fedora version, 
      # checks Fedora sources for the Python version, and sets the output.
      - name: Detect Python Version from Dockerfile
        id: detect_python
        shell: python
        env:
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          import re
          import requests
          import os
          import sys

          # Get the current branch name from GitHub context
          # For PRs, use base_ref (target branch), otherwise use ref_name
          branch_name = os.environ.get('GITHUB_BASE_REF') or os.environ.get('GITHUB_REF_NAME', 'master')
          print(f"[*] Current branch: {branch_name}")

          def get_fedora_version_from_dockerfile():
              # Try to fetch Dockerfile from the same branch name
              dockerfile_url = f"https://raw.githubusercontent.com/scylladb/scylladb/{branch_name}/tools/toolchain/Dockerfile"
              print(f"[*] Fetching Dockerfile: {dockerfile_url}")
              
              try:
                  resp = requests.get(dockerfile_url)
                  
                  # If branch not found, fall back to master
                  if resp.status_code == 404:
                      print(f"[!] Branch '{branch_name}' not found, falling back to master")
                      dockerfile_url = "https://raw.githubusercontent.com/scylladb/scylladb/master/tools/toolchain/Dockerfile"
                      print(f"[*] Fetching Dockerfile: {dockerfile_url}")
                      resp = requests.get(dockerfile_url)
                  
                  resp.raise_for_status()
                  content = resp.text
                  
                  # Strategy 1: Look for ARG FEDORA_VERSION=40
                  arg_match = re.search(r'ARG\s+FEDORA_VERSION=(\d+)', content)
                  if arg_match:
                      return arg_match.group(1)
                  
                  # Strategy 2: Look for FROM fedora:40
                  from_match = re.search(r'FROM\s+.*fedora:(\d+)', content)
                  if from_match:
                      return from_match.group(1)
                      
                  print("::error::Could not find FEDORA_VERSION or FROM fedora:XX in Dockerfile")
                  sys.exit(1)
              except Exception as e:
                  print(f"::error::Failed to fetch Dockerfile: {e}")
                  sys.exit(1)

          def get_python_version_from_fedora(fedora_ver):
              # Fallback mapping for known Fedora versions to Python versions
              fedora_python_map = {
                  '43': '3.13',
                  '42': '3.13',
                  '41': '3.13',
                  '40': '3.12',
                  '39': '3.11',
                  '38': '3.11',
                  '37': '3.11',
              }
              
              branch = f"f{fedora_ver}"
              # URL to the python3 spec file in Fedora's source tree
              spec_url = f"https://src.fedoraproject.org/rpms/python3/raw/{branch}/f/python3.spec"
              
              print(f"[*] Querying Fedora Sources for {branch}...")
              try:
                  resp = requests.get(spec_url, timeout=10)
                  
                  # Fallback to Rawhide if specific branch not found (common for very new/future versions)
                  if resp.status_code == 404:
                      print("[!] Branch not found, checking Rawhide...")
                      spec_url = "https://src.fedoraproject.org/rpms/python3/raw/rawhide/f/python3.spec"
                      resp = requests.get(spec_url, timeout=10)

                  if resp.status_code == 200:
                      # Parse "Version: 3.12.1" -> return "3.12"
                      version_match = re.search(r'^Version:\s+([\d\.]+)', resp.text, re.MULTILINE)
                      if version_match:
                          full_ver = version_match.group(1)
                          # Take only Major.Minor for actions/setup-python (e.g., 3.12)
                          short_ver = ".".join(full_ver.split('.')[:2])
                          print(f"[*] Found Python {short_ver} from Fedora spec file")
                          return short_ver
              except Exception as e:
                  print(f"[!] Error querying Fedora sources: {e}")
              
              # Use fallback mapping if API query failed
              if fedora_ver in fedora_python_map:
                  py_ver = fedora_python_map[fedora_ver]
                  print(f"[!] Using fallback mapping: Fedora {fedora_ver} -> Python {py_ver}")
                  return py_ver
              
              # Default fallback
              print(f"[!] No mapping found for Fedora {fedora_ver}, defaulting to Python 3.13")
              return "3.13"

          # --- Main Execution ---
          fedora_ver = get_fedora_version_from_dockerfile()
          print(f"[*] Detected Fedora Version: {fedora_ver}")
          
          py_ver = get_python_version_from_fedora(fedora_ver)
          print(f"[*] Mapped to Python Version: {py_ver}")

          # Write to GITHUB_OUTPUT
          with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
              fh.write(f"matrix_python={py_ver}\n")

      # 3. Use the detected version for the actual work
      - name: Setup Target Python Environment
        uses: actions/setup-python@v6
        with:
          # This pulls the value from the previous step
          python-version: ${{ steps.detect_python.outputs.matrix_python }}
          architecture: x64

      - name: Verify Python Version
        run: |
          python --version
          echo "Environment successfully set to match ScyllaDB Toolchain!"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ steps.detect_python.outputs.matrix_python }}

      - name: sync dependencies
        run: |
            uv sync --all-extras
            
      - name: Run pre-commit
        run: |
            uv run pre-commit run --all-files

      - name: unittest
        run: |
            uv run pytest ./tests

      - name: Build RPM (Rockylinux:8)
        run: docker run -v `pwd`:/scylla-machine-image -w /scylla-machine-image  --rm rockylinux:8 bash -c 'dnf update -y; dnf install -y git ; git config --global --add safe.directory "*"; ./dist/redhat/build_rpm.sh -t centos8'

      - name: Build DEB (Ubuntu:22.04)
        run: docker run -v `pwd`:/scylla-machine-image -w /scylla-machine-image  --rm ubuntu:22.04 bash -c 'apt update -y; apt install -y git ; git config --global --add safe.directory "*"; ./dist/debian/build_deb.sh'
